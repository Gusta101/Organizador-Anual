{% extends 'core/base.html' %}

{% block title %}Cartões de Crédito{% endblock %}

{% block content %}
<div class='container-fluid p-0'>

    <div class='mb-3'>
        <a href='{% url "financeiro:home" %}' class='btn btn-sm btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'>
            ⬅ Voltar ao Dashboard Financeiro
        </a>
    </div>

    <div class='d-flex justify-content-between align-items-center mb-4'>
        <h3 class='m-0' style='font-family: "Caveat", cursive;'>Faturas em Aberto</h3>
        
        <button type='button' class='btn btn-animated bg-color5' data-bs-toggle='modal' data-bs-target='#modalNovaFatura'>
            + Nova Fatura
        </button>
    </div>

    <div class='row g-4'>
        {% for item in faturas_dados %}
        <div class='col-md-6 col-lg-4'>
            <div class='summary-card p-4 rounded position-relative'>
                <h4 style='font-family: "Caveat", cursive; color: var(--color3);'>
                    {{ item.fatura.nome_cartao }}
                </h4>
                <p class='text-muted mb-1'>Vencimento: {{ item.fatura.data_vencimento|date:'d/m/Y' }}</p>
                <p class='text-muted mb-3'>Fechamento: {{ item.fatura.data_fechamento|date:'d/m/Y' }}</p>

                <h2 class='valor negativo mb-4'>R$ {{ item.total_gasto|floatformat:2 }}</h2>

                <div class='d-flex gap-2 mb-2'>
                    <button type='button' class='btn btn-animated bg-color5 flex-grow-1 btn-nova-compra'
                        data-bs-toggle='modal' data-bs-target='#modalNovaCompraCartao'
                        data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'>
                        + Compra
                    </button>

                    <button type='button' class='btn btn-animated bg-color4 flex-grow-1 btn-pagar-antecipado'
                        data-bs-toggle='modal' data-bs-target='#modalPagamentoFatura'
                        data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'
                        data-fatura-valor='{{ item.total_gasto|stringformat:"f" }}'>
                        Pagar
                    </button>
                </div>
            </div>
        </div>
        {% empty %}
        <div class='col-12'>
            <div class='alert alert-success text-center' role='alert'>
                Nenhuma fatura em aberto! Tudo em dia.
            </div>
        </div>
        {% endfor %}
    </div>

</div>

<div class='modal fade' id='modalPagamentoFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>Confirmar Pagamento</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <p>Você está prestes a pagar a fatura do cartão <strong id='modalNomeCartao'></strong>.</p>

                <form id='formPagamentoFatura' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='valor_pagamento' class='form-label'>Valor do Pagamento</label>
                        <input type='number' class='form-control' id='valor_pagamento' name='valor_pagamento'
                            step='0.01' readonly>
                        <small class='text-muted'>O valor total da fatura será debitado da conta escolhida.</small>
                    </div>

                    <div class='mb-4'>
                        <label for='conta_pagamento' class='form-label'>Qual conta você vai usar para pagar?</label>
                        <select class='form-control' id='conta_pagamento' name='conta_pagamento' required>
                            <option value=''>Selecione uma conta...</option>
                            {% for conta in contas_ativas %}
                            <option value='{{ conta.id }}'>{{ conta.nome }} (Saldo: R$ {{
                                conta.saldo_atual|floatformat:2 }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Confirmar Pagamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaCompraCartao' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>
                    Adicionar Compra - <span id='modalCompraNomeCartao'></span>
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form id='formNovaCompra' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='descricao' class='form-label'>Descrição da Compra</label>
                        <input type='text' class='form-control' id='descricao' name='descricao' required
                            placeholder='Ex: Uber, iFood, Farmácia...'>
                    </div>

                    <div class='mb-3'>
                        <label for='valor_compra' class='form-label'>Valor</label>
                        <input type='number' class='form-control' id='valor_compra' name='valor' step='0.01' required
                            placeholder='0.00'>
                    </div>

                    <div class='mb-3'>
                        <label for='data_compra' class='form-label'>Data da Compra</label>
                        <input type='date' class='form-control' id='data_compra' name='data_compra' required>
                    </div>

                    <div class='mb-4'>
                        <label for='categoria' class='form-label'>Categoria</label>
                        <select class='form-control' id='categoria' name='categoria'>
                            <option value=''>Sem categoria...</option>
                            {% for cat in categorias %}
                            <option value='{{ cat.id }}'>{{ cat.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Guardar Compra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>
                    Cadastrar Nova Fatura
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_fatura" %}'>
                    {% csrf_token %}
                    
                    <div class='mb-3'>
                        <label for='nome_cartao' class='form-label'>Nome do Cartão</label>
                        <input type='text' class='form-control' id='nome_cartao' name='nome_cartao' required placeholder='Ex: Nubank, Inter, Itaú...'>
                    </div>

                    <div class='row mb-3'>
                        <div class='col-6'>
                            <label for='mes' class='form-label'>Mês de Referência</label>
                            <input type='number' class='form-control' id='mes' name='mes' min='1' max='12' required placeholder='Ex: 3'>
                        </div>
                        <div class='col-6'>
                            <label for='ano' class='form-label'>Ano</label>
                            <input type='number' class='form-control' id='ano' name='ano' required value='2026'>
                        </div>
                    </div>

                    <div class='mb-3'>
                        <label for='data_fechamento' class='form-label'>Data de Fechamento (Melhor dia para compra)</label>
                        <input type='date' class='form-control' id='data_fechamento' name='data_fechamento' required>
                    </div>

                    <div class='mb-4'>
                        <label for='data_vencimento' class='form-label'>Data de Vencimento</label>
                        <input type='date' class='form-control' id='data_vencimento' name='data_vencimento' required>
                    </div>
                    
                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Fatura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- Lógica para o Modal de Pagamento ---
        const botoesPagar = document.querySelectorAll('.btn-pagar-antecipado');
        const formPagamento = document.getElementById('formPagamentoFatura');
        const inputValor = document.getElementById('valor_pagamento');
        const labelNomeCartao = document.getElementById('modalNomeCartao');

        botoesPagar.forEach(botao => {
            botao.addEventListener('click', function() {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');
                const faturaValor = this.getAttribute('data-fatura-valor');

                labelNomeCartao.textContent = faturaNome;
                inputValor.value = faturaValor.replace(',', '.');
                formPagamento.action = "{% url 'financeiro:pagar_fatura' 0 %}".replace('0', faturaId);
            });
        });

        // --- Lógica para o Modal de Nova Compra ---
        const botoesCompra = document.querySelectorAll('.btn-nova-compra');
        const formNovaCompra = document.getElementById('formNovaCompra');
        const labelCompraNomeCartao = document.getElementById('modalCompraNomeCartao');
        
        // Define a data de hoje como padrão no input de data
        const inputDataCompra = document.getElementById('data_compra');
        inputDataCompra.valueAsDate = new Date();

        botoesCompra.forEach(botao => {
            botao.addEventListener('click', function() {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');

                labelCompraNomeCartao.textContent = faturaNome;
                formNovaCompra.action = "{% url 'financeiro:adicionar_compra_cartao' 0 %}".replace('0', faturaId);
            });
        });
    });
</script>
{% endblock %}