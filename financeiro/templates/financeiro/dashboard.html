{% extends 'core/base.html' %}

{% block title %}Resumo Financeiro{% endblock %}

{% block content %}
<div class='container-fluid p-0'>

    <div class='d-flex flex-wrap gap-2 mb-4 pb-2 border-bottom'>
        <a href='{% url "financeiro:painel_orcamentos" %}' class='btn btn-animated bg-color3 text-white'>
            üìä Or√ßamentos e Limites
        </a>
        <a href='{% url "financeiro:painel_objetivos" %}' class='btn btn-animated bg-color4 text-white'>
            üê∑ Cofres e Reservas
        </a>
    </div>

    <div class='d-flex justify-content-between align-items-center mb-4'>
        <h3 class='m-0' style='font-family: "Caveat", cursive;'>M√™s Atual</h3>
        <button type='button' class='btn btn-animated bg-color5' data-bs-toggle='modal'
            data-bs-target='#modalTransacao'>
            + Nova Transa√ß√£o
        </button>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <!-- Cards resumo -->
    <div class='row mb-4 g-3'>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center'>
                <h6 class='text-muted'>Receitas</h6>
                <p class='valor positivo fs-3'>R$ {{ total_receitas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center'>
                <h6 class='text-muted'>Despesas (Geral)</h6>
                <p class='valor negativo fs-3'>R$ {{ total_despesas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center border-primary'>
                <h6 class='text-muted'>Saldo Em Conta</h6>
                <p class='valor {% if saldo < 0 %}negativo{% else %}positivo{% endif %} fs-3'>
                    R$ {{ saldo|floatformat:2 }}
                </p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center' style='border: 2px dashed var(--color5);'>
                <h6 class='text-muted'>Previs√£o (Ap√≥s Faturas)</h6>
                <p class='valor {% if saldo_projetado < 0 %}negativo{% else %}text-color-dark{% endif %} fs-3'>
                    R$ {{ saldo_projetado|floatformat:2 }}
                </p>
            </div>
        </div>
    </div>

    <!-- Faturas -->
    <div class='mb-5'>
        <div class='d-flex justify-content-between align-items-center mb-3'>
            <h4 class='m-0' style='font-family: "Caveat", cursive;'>Faturas em Aberto</h4>
            <button type='button' class='btn btn-sm btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaFatura'>
                + Cadastrar Cart√£o
            </button>
        </div>

        <div class='row g-3'>
            {% for item in faturas_dados %}
            <div class='col-md-4'>
                <div class='summary-card p-3 rounded position-relative' style='border-left: 4px solid var(--color3);'>
                    <h5 style='font-family: "Caveat", cursive; color: var(--color3);' class='mb-0'>
                        {{ item.fatura.nome_cartao }}
                    </h5>
                    <p class='text-muted small mb-2'>Vence: {{ item.fatura.data_vencimento|date:'d/m/Y' }}</p>

                    <h3 class='valor negativo mb-3'>R$ {{ item.total_gasto|floatformat:2 }}</h3>

                    <div class='d-flex gap-2'>
                        <button type='button' class='btn btn-sm btn-animated bg-color5 flex-grow-1 btn-nova-compra'
                            data-bs-toggle='modal' data-bs-target='#modalNovaCompraCartao'
                            data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'>
                            + Compra
                        </button>
                        <button type='button' class='btn btn-sm btn-animated bg-color4 flex-grow-1 btn-pagar-antecipado'
                            data-bs-toggle='modal' data-bs-target='#modalPagamentoFatura'
                            data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'
                            data-fatura-valor='{{ item.total_gasto|stringformat:"f" }}'>
                            Pagar
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class='col-12'>
                <div class='alert text-center m-0 py-2'
                    style='background-color: var(--bg-body); border: 1px dashed var(--border-color); color: var(--text-main);'>
                    Nenhuma fatura em aberto! Tudo em dia.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Cards dashboard -->
    <div class='row mb-4 g-4'>
        <div class='col-md-6 col-lg-5'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Despesas por Categoria
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoCategorias'></canvas>
                </div>

                {% if total_despesas == 0 %}
                <p class='text-muted mt-3 text-center'>Nenhuma despesa registada este m√™s.</p>
                {% endif %}
            </div>
        </div>

        <div class='col-md-6 col-lg-7'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Fluxo de Caixa (√öltimos 6 Meses)
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoFluxo'></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas transa√ß√µes -->
    <div class='transactions-section mt-5'>
        <h4 class='mb-3' style='font-family: "Caveat", cursive;'>Lan√ßamentos Recentes</h4>
        <div class='table-responsive'>
            <table class='table finance-table align-middle'>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Conta</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in transacoes %}
                    <tr>
                        <td>{{ item.data_vencimento|date:'d/m/Y' }}</td>
                        <td>{{ item.descricao }}</td>
                        <td>{{ item.categoria.nome|default:'Sem categoria' }}</td>
                        <td>{{ item.conta.nome }}</td>
                        <td
                            class='{% if item.tipo == "RECEITA" %}positivo{% elif item.tipo == "DESPESA" %}negativo{% endif %}'>
                            {% if item.tipo == 'RECEITA' %}+{% elif item.tipo == 'DESPESA' %}-{% endif %}
                            R$ {{ item.valor|floatformat:2 }}
                        </td>
                        <td>
                            {% if item.efetivada %}
                            <span class='badge pago'>Efetivada</span>
                            {% else %}
                            <span class='badge pendente'>Pendente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan='6' class='text-center py-4'>
                            Nenhuma transa√ß√£o cadastrada ainda.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Configura√ß√µes inicias -->
    <div class='mt-5 pt-4 pb-4 border-top'>
        <h4 class='mb-3' style='font-family: "Caveat", cursive; color: var(--color3);'>
            ‚öôÔ∏è Configura√ß√µes Iniciais
        </h4>
        <p class='text-muted small mb-3'>Cadastre as suas contas banc√°rias e crie categorias para organizar os seus
            gastos.</p>

        <div class='d-flex gap-2'>
            <button type='button' class='btn btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaConta'>
                + Nova Conta Banc√°ria
            </button>
            <button type='button' class='btn btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaCategoria'>
                + Nova Categoria
            </button>
        </div>
    </div>

</div>

<!-- ========== MODAIS ========== -->
<!-- Transa√ß√µes -->
<div class='modal fade' id='modalTransacao' tabindex='-1' aria-labelledby='modalTransacaoLabel' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' id='modalTransacaoLabel' style='font-family: "Caveat", cursive;'>
                    Registrar Movimenta√ß√£o
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action=''>
                    {% csrf_token %}
                    {{ form.as_p }}

                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Transa√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Configura√ß√µes Inicias -->
<div class='modal fade' id='modalNovaConta' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>Cadastrar Conta
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_conta" %}'>
                    {% csrf_token %}
                    {{ conta_form.as_p }}
                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Conta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaCategoria' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>Criar Categoria
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_categoria" %}'>
                    {% csrf_token %}
                    {{ categoria_form.as_p }}
                    <a href="https://fontawesome.com/search?ic=free-collection" target="_blank">
                        < Lista de √≠cones>
                    </a>
                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Categoria</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Faturas -->
<div class='modal fade' id='modalPagamentoFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>Confirmar Pagamento</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <p>Voc√™ est√° prestes a pagar a fatura do cart√£o <strong id='modalNomeCartao'></strong>.</p>

                <form id='formPagamentoFatura' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='valor_pagamento' class='form-label'>Valor do Pagamento</label>
                        <input type='number' class='form-control' id='valor_pagamento' name='valor_pagamento'
                            step='0.01' readonly>
                        <small class='text-muted'>O valor total da fatura ser√° debitado da conta escolhida.</small>
                    </div>

                    <div class='mb-4'>
                        <label for='conta_pagamento' class='form-label'>Qual conta voc√™ vai usar para pagar?</label>
                        <select class='form-control' id='conta_pagamento' name='conta_pagamento' required>
                            <option value=''>Selecione uma conta...</option>
                            {% for conta in contas_ativas %}
                            <option value='{{ conta.id }}'>{{ conta.nome }} (Saldo: R$ {{
                                conta.saldo_atual|floatformat:2 }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Confirmar Pagamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaCompraCartao' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>
                    Adicionar Compra - <span id='modalCompraNomeCartao'></span>
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form id='formNovaCompra' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='descricao' class='form-label'>Descri√ß√£o da Compra</label>
                        <input type='text' class='form-control' id='descricao' name='descricao' required
                            placeholder='Ex: Uber, iFood, Farm√°cia...'>
                    </div>

                    <div class='mb-3'>
                        <label for='valor_compra' class='form-label'>Valor</label>
                        <input type='number' class='form-control' id='valor_compra' name='valor' step='0.01' required
                            placeholder='0.00'>
                    </div>

                    <div class='mb-3'>
                        <label for='data_compra' class='form-label'>Data da Compra</label>
                        <input type='date' class='form-control' id='data_compra' name='data_compra' required>
                    </div>

                    <div class='mb-4'>
                        <label for='categoria' class='form-label'>Categoria</label>
                        <select class='form-control' id='categoria' name='categoria'>
                            <option value=''>Sem categoria...</option>
                            {% for cat in categorias %}
                            <option value='{{ cat.id }}'>{{ cat.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Guardar Compra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>
                    Cadastrar Nova Fatura
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_fatura" %}'>
                    {% csrf_token %}
                    
                    <div class='mb-3'>
                        <label for='nome_cartao' class='form-label'>Nome do Cart√£o</label>
                        <input type='text' class='form-control' id='nome_cartao' name='nome_cartao' required placeholder='Ex: Nubank, Inter, Ita√∫...'>
                    </div>

                    <div class='row mb-3'>
                        <div class='col-6'>
                            <label for='mes' class='form-label'>M√™s de Refer√™ncia</label>
                            <input type='number' class='form-control' id='mes' name='mes' min='1' max='12' required placeholder='Ex: 3'>
                        </div>
                        <div class='col-6'>
                            <label for='ano' class='form-label'>Ano</label>
                            <input type='number' class='form-control' id='ano' name='ano' required value='2026'>
                        </div>
                    </div>

                    <div class='mb-3'>
                        <label for='data_fechamento' class='form-label'>Data de Fechamento (Melhor dia para compra)</label>
                        <input type='date' class='form-control' id='data_fechamento' name='data_fechamento' required>
                    </div>

                    <div class='mb-4'>
                        <label for='data_vencimento' class='form-label'>Data de Vencimento</label>
                        <input type='date' class='form-control' id='data_vencimento' name='data_vencimento' required>
                    </div>
                    
                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Fatura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Gr√°ficos -->
<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==========================================
        // GR√ÅFICO DE ROSCA (DESPESAS POR CATEGORIA)
        // ==========================================
        const labels = JSON.parse('{{ labels_grafico|safe }}');
        const valores = JSON.parse('{{ valores_grafico|safe }}');
        const cores = JSON.parse('{{ cores_grafico|safe }}');

        // S√≥ renderiza o gr√°fico se houver dados
        if (valores.length > 0) {
            const ctx = document.getElementById('graficoCategorias').getContext('2d');

            // Vai buscar as cores do seu tema para o texto do gr√°fico adaptar-se ao Dark Mode
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-main').trim() || '#333';

            new Chart(ctx, {
                type: 'doughnut', // Gr√°fico de Rosca
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: cores,
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--bg-body').trim() // Borda herda o fundo
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: {
                                    family: "'Patrick Hand', cursive",
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += 'R$ ' + context.parsed.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // GR√ÅFICO DE BARRAS (FLUXO DE CAIXA)
        // ==========================================
        const labelsFluxo = JSON.parse('{{ meses_labels|safe }}');
        const dadosReceitas = JSON.parse('{{ receitas_data|safe }}');
        const dadosDespesas = JSON.parse('{{ despesas_data|safe }}');

        const ctxFluxo = document.getElementById('graficoFluxo').getContext('2d');
        const corLinhaGrid = getComputedStyle(document.body).getPropertyValue('--border-color').trim();

        new Chart(ctxFluxo, {
            type: 'bar',
            data: {
                labels: labelsFluxo,
                datasets: [
                    {
                        label: 'Receitas',
                        data: dadosReceitas,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)', // Verde
                        borderColor: '#2ecc71',
                        borderWidth: 1,
                        borderRadius: 4 // Arredonda o topo das barras
                    },
                    {
                        label: 'Despesas',
                        data: dadosDespesas,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)', // Vermelho
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor, // Usa a vari√°vel de texto do Dark Mode criada no gr√°fico anterior
                            font: { family: "'Patrick Hand', cursive", size: 14 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, font: { family: "'Patrick Hand', cursive" } },
                        grid: { color: corLinhaGrid } // As linhas do fundo adaptam-se ao modo claro/escuro
                    },
                    x: {
                        ticks: { color: textColor, font: { family: "'Patrick Hand', cursive", size: 13 } },
                        grid: { display: false } // Remove as linhas verticais para ficar mais limpo
                    }
                }
            }
        });
    });
</script>

<!-- Modais fatura -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // --- L√≥gica para o Modal de Pagamento ---
        const botoesPagar = document.querySelectorAll('.btn-pagar-antecipado');
        const formPagamento = document.getElementById('formPagamentoFatura');
        const inputValor = document.getElementById('valor_pagamento');
        const labelNomeCartao = document.getElementById('modalNomeCartao');

        botoesPagar.forEach(botao => {
            botao.addEventListener('click', function() {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');
                const faturaValor = this.getAttribute('data-fatura-valor');

                labelNomeCartao.textContent = faturaNome;
                inputValor.value = faturaValor.replace(',', '.');
                formPagamento.action = "{% url 'financeiro:pagar_fatura' 0 %}".replace('0', faturaId);
            });
        });

        // --- L√≥gica para o Modal de Nova Compra ---
        const botoesCompra = document.querySelectorAll('.btn-nova-compra');
        const formNovaCompra = document.getElementById('formNovaCompra');
        const labelCompraNomeCartao = document.getElementById('modalCompraNomeCartao');
        
        // Define a data de hoje como padr√£o no input de data
        const inputDataCompra = document.getElementById('data_compra');
        inputDataCompra.valueAsDate = new Date();

        botoesCompra.forEach(botao => {
            botao.addEventListener('click', function() {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');

                labelCompraNomeCartao.textContent = faturaNome;
                formNovaCompra.action = "{% url 'financeiro:adicionar_compra_cartao' 0 %}".replace('0', faturaId);
            });
        });
    });
</script>

{% endblock %}