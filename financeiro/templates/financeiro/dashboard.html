{% extends 'core/base.html' %}

{% block title %}Resumo Financeiro{% endblock %}

{% block content %}
<div class='container-fluid p-0'>

    <div class='d-flex flex-wrap gap-2 mb-4 pb-2 border-bottom'>
        <a href='{% url "financeiro:painel_cartoes" %}' class='btn btn-animated bg-color2 text-white'>
            üí≥ Cart√µes de Cr√©dito
        </a>
        <a href='{% url "financeiro:painel_orcamentos" %}' class='btn btn-animated bg-color3 text-white'>
            üìä Or√ßamentos e Limites
        </a>
        <a href='{% url "financeiro:painel_objetivos" %}' class='btn btn-animated bg-color4 text-white'>
            üê∑ Cofres e Reservas
        </a>
    </div>

    <div class='d-flex justify-content-between align-items-center mb-4'>
        <h3 class='m-0' style='font-family: "Caveat", cursive;'>M√™s Atual</h3>
        <button type='button' class='btn btn-animated bg-color5' data-bs-toggle='modal'
            data-bs-target='#modalTransacao'>
            + Nova Transa√ß√£o
        </button>
    </div>

    <div class='row mb-4 g-3'>
        <div class='col-md-4'>
            <div class='summary-card p-3 rounded text-center'>
                <h5 class='text-muted'>Receitas</h5>
                <p class='valor positivo fs-2'>R$ {{ total_receitas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-4'>
            <div class='summary-card p-3 rounded text-center'>
                <h5 class='text-muted'>Despesas</h5>
                <p class='valor negativo fs-2'>R$ {{ total_despesas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-4'>
            <div class='summary-card p-3 rounded text-center border-primary'>
                <h5 class='text-muted'>Saldo Atual Geral</h5>
                <p class='valor {% if saldo < 0 %}negativo{% else %}positivo{% endif %} fs-2'>
                    R$ {{ saldo|floatformat:2 }}
                </p>
            </div>
        </div>
    </div>

    <div class='row mb-4 g-4'>
        <div class='col-md-6 col-lg-5'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Despesas por Categoria
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoCategorias'></canvas>
                </div>

                {% if total_despesas == 0 %}
                <p class='text-muted mt-3 text-center'>Nenhuma despesa registada este m√™s.</p>
                {% endif %}
            </div>
        </div>

        <div class='col-md-6 col-lg-7'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Fluxo de Caixa (√öltimos 6 Meses)
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoFluxo'></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class='transactions-section mt-5'>
        <h4 class='mb-3' style='font-family: "Caveat", cursive;'>Lan√ßamentos Recentes</h4>
        <div class='table-responsive'>
            <table class='table finance-table align-middle'>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Conta</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in transacoes %}
                    <tr>
                        <td>{{ item.data_vencimento|date:'d/m/Y' }}</td>
                        <td>{{ item.descricao }}</td>
                        <td>{{ item.categoria.nome|default:'Sem categoria' }}</td>
                        <td>{{ item.conta.nome }}</td>
                        <td
                            class='{% if item.tipo == "RECEITA" %}positivo{% elif item.tipo == "DESPESA" %}negativo{% endif %}'>
                            {% if item.tipo == 'RECEITA' %}+{% elif item.tipo == 'DESPESA' %}-{% endif %}
                            R$ {{ item.valor|floatformat:2 }}
                        </td>
                        <td>
                            {% if item.efetivada %}
                            <span class='badge pago'>Efetivada</span>
                            {% else %}
                            <span class='badge pendente'>Pendente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan='6' class='text-center py-4'>
                            Nenhuma transa√ß√£o cadastrada ainda.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<div class='modal fade' id='modalTransacao' tabindex='-1' aria-labelledby='modalTransacaoLabel' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' id='modalTransacaoLabel' style='font-family: "Caveat", cursive;'>
                    Registrar Movimenta√ß√£o
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action=''>
                    {% csrf_token %}
                    {{ form.as_p }}

                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Transa√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ==========================================
        // GR√ÅFICO DE ROSCA (DESPESAS POR CATEGORIA)
        // ==========================================
        const labels = JSON.parse('{{ labels_grafico|safe }}');
        const valores = JSON.parse('{{ valores_grafico|safe }}');
        const cores = JSON.parse('{{ cores_grafico|safe }}');

        // S√≥ renderiza o gr√°fico se houver dados
        if (valores.length > 0) {
            const ctx = document.getElementById('graficoCategorias').getContext('2d');

            // Vai buscar as cores do seu tema para o texto do gr√°fico adaptar-se ao Dark Mode
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-main').trim() || '#333';

            new Chart(ctx, {
                type: 'doughnut', // Gr√°fico de Rosca
                data: {
                    labels: labels,
                    datasets: [{
                        data: valores,
                        backgroundColor: cores,
                        borderWidth: 2,
                        borderColor: getComputedStyle(document.body).getPropertyValue('--bg-body').trim() // Borda herda o fundo
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: textColor,
                                font: {
                                    family: "'Patrick Hand', cursive",
                                    size: 14
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    let label = context.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed !== null) {
                                        label += 'R$ ' + context.parsed.toFixed(2);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==========================================
        // GR√ÅFICO DE BARRAS (FLUXO DE CAIXA)
        // ==========================================
        const labelsFluxo = JSON.parse('{{ meses_labels|safe }}');
        const dadosReceitas = JSON.parse('{{ receitas_data|safe }}');
        const dadosDespesas = JSON.parse('{{ despesas_data|safe }}');

        const ctxFluxo = document.getElementById('graficoFluxo').getContext('2d');
        const corLinhaGrid = getComputedStyle(document.body).getPropertyValue('--border-color').trim();

        new Chart(ctxFluxo, {
            type: 'bar',
            data: {
                labels: labelsFluxo,
                datasets: [
                    {
                        label: 'Receitas',
                        data: dadosReceitas,
                        backgroundColor: 'rgba(46, 204, 113, 0.7)', // Verde
                        borderColor: '#2ecc71',
                        borderWidth: 1,
                        borderRadius: 4 // Arredonda o topo das barras
                    },
                    {
                        label: 'Despesas',
                        data: dadosDespesas,
                        backgroundColor: 'rgba(231, 76, 60, 0.7)', // Vermelho
                        borderColor: '#e74c3c',
                        borderWidth: 1,
                        borderRadius: 4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: textColor, // Usa a vari√°vel de texto do Dark Mode criada no gr√°fico anterior
                            font: { family: "'Patrick Hand', cursive", size: 14 }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function (context) {
                                return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: { color: textColor, font: { family: "'Patrick Hand', cursive" } },
                        grid: { color: corLinhaGrid } // As linhas do fundo adaptam-se ao modo claro/escuro
                    },
                    x: {
                        ticks: { color: textColor, font: { family: "'Patrick Hand', cursive", size: 13 } },
                        grid: { display: false } // Remove as linhas verticais para ficar mais limpo
                    }
                }
            }
        });
    });
</script>

{% endblock %}