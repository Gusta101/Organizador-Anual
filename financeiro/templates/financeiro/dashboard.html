{% extends 'core/base.html' %}
{% load heatmap_tools %}

{% block title %}Resumo Financeiro{% endblock %}

{% block content %}
<div class='container-fluid p-0'>

    <!-- Nav financeiro -->
    <div class='d-flex flex-wrap gap-2 mb-4 pb-2 border-bottom'>
        <a href='{% url "financeiro:painel_orcamentos" %}' class='btn btn-animated bg-color3 text-white'>
            <i class='fa-solid fa-chart-column me-2'></i> Or√ßamentos e Limites
        </a>
        <a href='{% url "financeiro:painel_objetivos" %}' class='btn btn-animated bg-color4 text-white'>
            <i class='fa-solid fa-piggy-bank me-2'></i> Cofres e Reservas
        </a>
    </div>

    <!-- Bot√µes fun√ß√£o -->
    <div class='d-flex justify-content-between align-items-center mb-4'>

        <div class="d-flex align-items-center gap-3">
            <a href="?mes={{ mes_anterior }}&ano={{ ano_anterior }}" class="btn btn-sm btn-outline-secondary"
                style="border-radius: 30%;">
                <i class="fas fa-chevron-left"></i>
            </a>

            <h3 class='m-0 text-center' style='font-family: "Caveat", cursive; min-width: 150px;'>
                {{ nome_mes_selecionado }} {{ ano_selecionado }}
            </h3>

            <a href="?mes={{ mes_seguinte }}&ano={{ ano_seguinte }}" class="btn btn-sm btn-outline-secondary"
                style="border-radius: 30%;">
                <i class="fas fa-chevron-right"></i>
            </a>

            {% if nome_mes_selecionado != "Fevereiro" or ano_selecionado != 2026 %}
            <a href="{% url 'financeiro:home' %}" class="btn btn-sm btn-link text-muted ms-2">Voltar p/ Hoje</a>
            {% endif %}
        </div>

        <button type='button' class='btn btn-animated bg-color5' data-bs-toggle='modal'
            data-bs-target='#modalTransacao'>
            + Nova Transa√ß√£o
        </button>
    </div>

    <!-- ========== DASHBOARD ========== -->
    <!-- Cards resumo -->
    <div class='row mb-4 g-3'>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center'>
                <h6 class='text-muted'>Receitas</h6>
                <p class='valor positivo fs-3'>R$ {{ total_receitas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center'>
                <h6 class='text-muted'>Despesas (Geral)</h6>
                <p class='valor negativo fs-3'>R$ {{ total_despesas|floatformat:2 }}</p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center border-primary'>
                <h6 class='text-muted'>Saldo Em Conta</h6>
                <p class='valor {% if saldo < 0 %}negativo{% else %}positivo{% endif %} fs-3'>
                    R$ {{ saldo|floatformat:2 }}
                </p>
            </div>
        </div>
        <div class='col-md-3'>
            <div class='summary-card p-3 rounded text-center' style='border: 2px dashed var(--color5);'>
                <h6 class='text-muted'>Previs√£o (Ap√≥s Faturas)</h6>
                <p class='valor {% if saldo_projetado < 0 %}negativo{% else %}text-color-dark{% endif %} fs-3'>
                    R$ {{ saldo_projetado|floatformat:2 }}
                </p>
            </div>
        </div>
    </div>

    <!-- Faturas -->
    <div class='mb-5'>
        <div class='d-flex justify-content-between align-items-center mb-3'>
            <h4 class='m-0' style='font-family: "Caveat", cursive;'>Faturas em Aberto</h4>
            <button type='button' class='btn btn-sm btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaFatura'>
                + Cadastrar Cart√£o
            </button>
        </div>

        <div class='row g-3'>
            {% for item in faturas_dados %}
            <div class='col-md-4'>
                <div class='summary-card p-3 rounded position-relative' style='border-left: 4px solid var(--color3);'>

                    {% if item.is_futura %}
                    <span class='badge bg-secondary position-absolute top-0 end-0 mt-2 me-2'>
                        <i class="fa-solid fa-exclamation me-2"></i>Pr√≥xima Fatura<i
                            class="fa-solid fa-exclamation ms-2"></i>
                    </span>
                    {% endif %}

                    <h5 style='font-family: "Caveat", cursive; color: var(--color3);' class='mb-0'>
                        {{ item.fatura.nome_cartao }}
                    </h5>
                    <p class='text-muted small mb-2'>Vence: {{ item.fatura.data_vencimento|date:'d/m/Y' }}</p>

                    <h3 class='valor negativo mb-3'>R$ {{ item.total_gasto|floatformat:2 }}</h3>

                    <div class='d-flex gap-2'>
                        <button type='button' class='btn btn-sm btn-animated bg-color5 flex-grow-1 btn-nova-compra'
                            data-bs-toggle='modal' data-bs-target='#modalNovaCompraCartao'
                            data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'>
                            + Compra
                        </button>
                        <button type='button' class='btn btn-sm btn-animated bg-color4 flex-grow-1 btn-pagar-antecipado'
                            data-bs-toggle='modal' data-bs-target='#modalPagamentoFatura'
                            data-fatura-id='{{ item.fatura.id }}' data-fatura-nome='{{ item.fatura.nome_cartao }}'
                            data-fatura-valor='{{ item.total_gasto|stringformat:"f" }}'>
                            Pagar
                        </button>
                    </div>
                </div>
            </div>
            {% empty %}
            <div class='col-12'>
                <div class='alert text-center m-0 py-2'
                    style='background-color: var(--bg-body); border: 1px dashed var(--border-color); color: var(--text-main);'>
                    Nenhuma fatura em aberto! Tudo em dia.
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Dashboard Mensal -->
     <h4 class="mb-3 mt-5">An√°lise Mensal</h4>

    <div class='row mb-4 g-4'>
        <div class='col-md-6 col-lg-5'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Despesas por Categoria (M√™s)
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoCategoriasMensal'></canvas>
                </div>

                {% if total_despesas == 0 %}
                <p class='text-muted mt-3 text-center'>Nenhuma despesa registada este m√™s.</p>
                {% endif %}
            </div>
        </div>

        <div class='col-md-6 col-lg-7'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Fluxo de Caixa (√öltimos 6 Meses)
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoFluxo'></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Dashboard Di√°rio -->
    <h4 class='mb-3 mt-5'>An√°lise Di√°ria</h4>

    <div class='row mb-4 g-4'>

        <div class='col-md-4'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center justify-content-center'>
                <h4 class='mb-3 text-center' style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Mapa de Gastos
                </h4>
                {% render_calendario_gastos mes_selecionado ano_selecionado gastos_diarios maior_gasto_diario %}
                <p class='text-muted small mt-3 text-center'>Clique num dia para ver os detalhes.</p>
            </div>
        </div>

        <div class='col-md-4'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column align-items-center'>
                <h4 id="titulo-grafico-diario" class='mb-3 text-center'
                    style='font-family: "Caveat", cursive; color: var(--color3);'>
                    Despesas do Dia
                </h4>

                <div style='position: relative; height: 250px; width: 100%;'>
                    <canvas id='graficoCategoriasDiario' style="display: none;"></canvas>
                </div>

                <p id="msg-selecione-dia" class='text-muted mt-5 text-center'>üëà Selecione um dia no calend√°rio ao lado.
                </p>
                <p id="msg-sem-dados-diario" class='text-muted mt-5 text-center' style="display: none;">Nenhuma despesa
                    registada neste dia.</p>
            </div>
        </div>

        <div class='col-md-4'>
            <div class='summary-card p-4 rounded h-100 d-flex flex-column'>
                <h4 id="titulo-tabela-dia" class='mb-3 text-center'
                    style='font-family: "Caveat", cursive; color: var(--color5);'>
                    Transa√ß√µes do Dia
                </h4>

                <div class="table-responsive" style="max-height: 250px; overflow-y: auto;">
                    <table class="table table-sm align-middle" style="font-size: 0.9rem;">
                        <tbody id="tabela-dia-body">
                            <tr>
                                <td class="text-center text-muted py-5">Nenhum dia selecionado.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabelas transa√ß√µes -->
    <div class='transactions-section mt-5'>
        <h4 class='mb-3' style='font-family: "Caveat", cursive;'>Lan√ßamentos Recentes</h4>
        <div class='table-responsive'>
            <table class='table finance-table align-middle'>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Descri√ß√£o</th>
                        <th>Categoria</th>
                        <th>Conta</th>
                        <th>Valor</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for item in transacoes %}
                    <tr>
                        <td>{{ item.data_vencimento|date:'d/m/Y' }}</td>
                        <td>{{ item.descricao }}</td>
                        <td>{{ item.categoria.nome|default:'Sem categoria' }}</td>
                        <td>{{ item.conta.nome }}</td>
                        <td
                            class='{% if item.tipo == "RECEITA" %}positivo{% elif item.tipo == "DESPESA" %}negativo{% endif %}'>
                            {% if item.tipo == 'RECEITA' %}+{% elif item.tipo == 'DESPESA' %}-{% endif %}
                            R$ {{ item.valor|floatformat:2 }}
                        </td>
                        <td>
                            {% if item.efetivada %}
                            <span class='badge pago'>Efetivada</span>
                            {% else %}
                            <span class='badge pendente'>Pendente</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan='6' class='text-center py-4'>
                            Nenhuma transa√ß√£o cadastrada ainda.
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Configura√ß√µes inicias -->
    <div class='mt-5 pt-4 pb-4 border-top'>
        <h4 class='mb-3' style='font-family: "Caveat", cursive; color: var(--color3);'>
            ‚öôÔ∏è Configura√ß√µes Iniciais
        </h4>
        <p class='text-muted small mb-3'>Cadastre as suas contas banc√°rias e crie categorias para organizar os seus
            gastos.</p>

        <div class='d-flex gap-2'>
            <button type='button' class='btn btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaConta'>
                + Nova Conta Banc√°ria
            </button>
            <button type='button' class='btn btn-outline-secondary' style='font-family: "Patrick Hand", cursive;'
                data-bs-toggle='modal' data-bs-target='#modalNovaCategoria'>
                + Nova Categoria
            </button>
        </div>
    </div>

</div>

<!-- ========== MODAIS ========== -->
<!-- Transa√ß√µes -->
<div class='modal fade' id='modalTransacao' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>Registrar
                    Movimenta√ß√£o</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        {{ form.descricao.label_tag }} {{ form.descricao }}
                    </div>
                    <div class='row mb-3'>
                        <div class='col-6'>{{ form.tipo.label_tag }} {{ form.tipo }}</div>
                        <div class='col-6'>{{ form.valor.label_tag }} {{ form.valor }}</div>
                    </div>
                    <div class='row mb-3'>
                        <div class='col-6'>{{ form.data_vencimento.label_tag }} {{ form.data_vencimento }}</div>
                        <div class='col-6 pt-4'>
                            <div class='form-check'>
                                {{ form.efetivada }}
                                <label class='form-check-label fw-bold' for='{{ form.efetivada.id_for_label }}'>J√° foi
                                    pago/recebido?</label>
                            </div>
                        </div>
                    </div>
                    <div class='row mb-4'>
                        <div class='col-6'>{{ form.conta.label_tag }} {{ form.conta }}</div>
                        <div class='col-6'>{{ form.categoria.label_tag }} {{ form.categoria }}</div>
                    </div>

                    <div class='p-3 mb-4 rounded'
                        style='background-color: var(--bg-body); border: 1px dashed var(--color5);'>
                        <div class='form-check mb-2'>
                            {{ form.recorrente }}
                            <label class='form-check-label text-color-dark fw-bold' for='check_recorrente'>
                                <i class="fa-solid fa-arrow-rotate-left me-2"></i>Repetir nos pr√≥ximos meses?
                                (Recorr√™ncia/Parcelamento)
                            </label>
                        </div>
                        <div id='div_parcelas' class='mt-2' style='display: none;'>
                            {{ form.parcelas.label_tag }}
                            {{ form.parcelas }}
                            <small class='text-muted'>Ser√£o geradas transa√ß√µes pendentes para os meses seguintes
                                automaticamente.</small>
                        </div>
                    </div>

                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Transa√ß√£o</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Faturas -->
<div class='modal fade' id='modalPagamentoFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>Confirmar Pagamento</h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <p>Voc√™ est√° prestes a pagar a fatura do cart√£o <strong id='modalNomeCartao'></strong>.</p>

                <form id='formPagamentoFatura' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='valor_pagamento' class='form-label'>Valor do Pagamento</label>
                        <input type='number' class='form-control' id='valor_pagamento' name='valor_pagamento'
                            step='0.01' readonly>
                        <small class='text-muted'>O valor total da fatura ser√° debitado da conta escolhida.</small>
                    </div>

                    <div class='mb-4'>
                        <label for='conta_pagamento' class='form-label'>Qual conta voc√™ vai usar para pagar?</label>
                        <select class='form-control' id='conta_pagamento' name='conta_pagamento' required>
                            <option value=''>Selecione uma conta...</option>
                            {% for conta in contas_ativas %}
                            <option value='{{ conta.id }}'>{{ conta.nome }} (Saldo: R$ {{
                                conta.saldo_atual|floatformat:2 }})</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Confirmar Pagamento</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaCompraCartao' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive;'>Nova Compra - <span
                        id='modalCompraNomeCartao'></span></h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form id='formNovaCompra' method='POST' action=''>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='descricao' class='form-label'>Descri√ß√£o da Compra</label>
                        <input type='text' class='form-control' id='descricao' name='descricao' required
                            placeholder='Ex: Smartphone, Assinatura Spotify...'>
                    </div>

                    <div class='row mb-3'>
                        <div class='col-6'>
                            <label for='valor_compra' class='form-label'>Valor (da Parcela)</label>
                            <input type='number' class='form-control' id='valor_compra' name='valor' step='0.01'
                                required placeholder='Ex: 50.00'>
                        </div>
                        <div class='col-6'>
                            <label for='data_compra' class='form-label'>Data da Compra</label>
                            <input type='date' class='form-control' id='data_compra' name='data_compra' required>
                        </div>
                    </div>

                    <div class='mb-4'>
                        <label for='categoria' class='form-label'>Categoria</label>
                        <select class='form-control' id='categoria' name='categoria'>
                            <option value=''>Sem categoria...</option>
                            {% for cat in categorias %}
                            <option value='{{ cat.id }}'>{{ cat.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class='p-3 mb-4 rounded'
                        style='background-color: var(--bg-body); border: 1px dashed var(--color4);'>
                        <div class='form-check mb-2'>
                            <input type='checkbox' class='form-check-input' id='check_recorrente_cartao'
                                name='recorrente_cartao'>
                            <label class='form-check-label text-color-dark fw-bold' for='check_recorrente_cartao'>
                                <i class="fa-jelly fa-regular fa-credit-card me-2"></i>Compra Parcelada ou Assinatura
                                Mensal?
                            </label>
                        </div>
                        <div id='div_parcelas_cartao' class='mt-2' style='display: none;'>
                            <label for='parcelas_cartao' class='form-label'>Em quantas vezes? (Meses)</label>
                            <input type='number' class='form-control' id='parcelas_cartao' name='parcelas_cartao'
                                min='2' value='2'>
                            <small class='text-muted'>As faturas dos pr√≥ximos meses ser√£o criadas automaticamente se n√£o
                                existirem.</small>
                        </div>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Guardar Compra</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaFatura' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>
                    Cadastrar Nova Fatura
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_fatura" %}'>
                    {% csrf_token %}

                    <div class='mb-3'>
                        <label for='nome_cartao' class='form-label'>Nome do Cart√£o</label>
                        <input type='text' class='form-control' id='nome_cartao' name='nome_cartao' required
                            placeholder='Ex: Nubank, Inter, Ita√∫...'>
                    </div>

                    <div class='row mb-3'>
                        <div class='col-6'>
                            <label for='mes' class='form-label'>M√™s de Refer√™ncia</label>
                            <input type='number' class='form-control' id='mes' name='mes' min='1' max='12' required
                                placeholder='Ex: 3'>
                        </div>
                        <div class='col-6'>
                            <label for='ano' class='form-label'>Ano</label>
                            <input type='number' class='form-control' id='ano' name='ano' required value='2026'>
                        </div>
                    </div>

                    <div class='mb-3'>
                        <label for='data_fechamento' class='form-label'>Data de Fechamento (Melhor dia para
                            compra)</label>
                        <input type='date' class='form-control' id='data_fechamento' name='data_fechamento' required>
                    </div>

                    <div class='mb-4'>
                        <label for='data_vencimento' class='form-label'>Data de Vencimento</label>
                        <input type='date' class='form-control' id='data_vencimento' name='data_vencimento' required>
                    </div>

                    <div class='text-end'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Fatura</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Configura√ß√µes Inicias -->
<div class='modal fade' id='modalNovaConta' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>Cadastrar Conta
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_conta" %}'>
                    {% csrf_token %}
                    {{ conta_form.as_p }}
                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Conta</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class='modal fade' id='modalNovaCategoria' tabindex='-1' aria-hidden='true'>
    <div class='modal-dialog modal-dialog-centered'>
        <div class='modal-content custom-modal-content'>
            <div class='modal-header border-bottom-0'>
                <h5 class='modal-title' style='font-family: "Caveat", cursive; color: var(--color5);'>Criar Categoria
                </h5>
                <button type='button' class='btn-close' data-bs-dismiss='modal' aria-label='Close'></button>
            </div>
            <div class='modal-body'>
                <form method='POST' action='{% url "financeiro:nova_categoria" %}'>
                    {% csrf_token %}
                    {{ categoria_form.as_p }}
                    <a href="https://fontawesome.com/search?ic=free-collection" target="_blank">
                        < Lista de √≠cones>
                    </a>
                    <div class='text-end mt-4'>
                        <button type='submit' class='btn btn-animated bg-color5'>Salvar Categoria</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- ========== JavaScript ========== -->
<!-- Gr√°ficos -->
<script src='https://cdn.jsdelivr.net/npm/chart.js'></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {

        document.fonts.ready.then(function () {

            // Define a fonte e a cor para todos os textos de todos os gr√°ficos
            Chart.defaults.font.family = '\'Balsamiq Sans\', cursive';
            Chart.defaults.color = getComputedStyle(document.body).getPropertyValue('--text-main').trim() || '#333';

            // ==========================================
            // 1. GR√ÅFICO DE ROSCA (VIS√ÉO MENSAL EST√ÅTICA)
            // ==========================================
            const labelsMensais = JSON.parse('{{ labels_grafico|safe }}');
            const valoresMensais = JSON.parse('{{ valores_grafico|safe }}');
            const coresMensais = JSON.parse('{{ cores_grafico|safe }}');

            if (valoresMensais.length > 0) {
                const ctxMensal = document.getElementById('graficoCategoriasMensal').getContext('2d');
                new Chart(ctxMensal, {
                    type: 'doughnut',
                    data: {
                        labels: labelsMensais,
                        datasets: [{
                            data: valoresMensais,
                            backgroundColor: coresMensais,
                            borderWidth: 2,
                            borderColor: getComputedStyle(document.body).getPropertyValue('--bg-body').trim()
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { position: 'right', labels: { size: 14 } } }
                    }
                });
            }

            // ==========================================
            // 2. GR√ÅFICO DE ROSCA (VIS√ÉO DI√ÅRIA DIN√ÇMICA)
            // ==========================================
            const ctxDiario = document.getElementById('graficoCategoriasDiario').getContext('2d');
            // Inicializa vazio
            let chartDiario = new Chart(ctxDiario, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: [], borderWidth: 2 }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { size: 12 } } }
                }
            });

            // ==========================================
            // 3. L√ìGICA DE INTERA√á√ÉO DO CALEND√ÅRIO
            // ==========================================
            const tituloGraficoDiario = document.getElementById('titulo-grafico-diario');
            const msgSelecione = document.getElementById('msg-selecione-dia');
            const msgSemDados = document.getElementById('msg-sem-dados-diario');
            const canvasDiario = document.getElementById('graficoCategoriasDiario');

            const tbodyTabela = document.getElementById('tabela-dia-body');
            const tituloTabela = document.getElementById('titulo-tabela-dia');

            document.querySelectorAll('.finance-day').forEach(dayDiv => {
                dayDiv.addEventListener('click', function () {
                    const dia = this.getAttribute('data-dia');
                    const mes = this.getAttribute('data-mes');
                    const ano = this.getAttribute('data-ano');

                    if (!dia) return; // Ignora os dias em branco do calend√°rio

                    // Destaca visualmente o dia clicado
                    document.querySelectorAll('.finance-day').forEach(d => d.style.border = 'none');
                    this.style.border = '2px solid var(--text-main)';

                    // Chama a API interna para buscar os dados do dia
                    fetch(`/financeiro/api/detalhes-dia/?dia=${dia}&mes=${mes}&ano=${ano}`)
                        .then(response => response.json())
                        .then(data => {

                            // Atualiza T√≠tulos
                            tituloGraficoDiario.innerText = `Despesas: ${data.data_formatada}`;
                            tituloTabela.innerText = `Lan√ßamentos: ${data.data_formatada}`;

                            msgSelecione.style.display = 'none'; // Esconde a mensagem inicial

                            // Atualiza o Gr√°fico de Pizza Di√°rio
                            if (data.grafico.valores.length === 0) {
                                msgSemDados.style.display = 'block';
                                canvasDiario.style.display = 'none';
                            } else {
                                msgSemDados.style.display = 'none';
                                canvasDiario.style.display = 'block';
                                chartDiario.data.labels = data.grafico.labels;
                                chartDiario.data.datasets[0].data = data.grafico.valores;
                                chartDiario.data.datasets[0].backgroundColor = data.grafico.cores;
                                chartDiario.data.datasets[0].borderColor = getComputedStyle(document.body).getPropertyValue('--bg-body').trim();
                                chartDiario.update();
                            }

                            // Atualiza a Tabela do Dia
                            tbodyTabela.innerHTML = '';
                            if (data.transacoes.length === 0) {
                                tbodyTabela.innerHTML = '<tr><td class="text-center text-muted py-4">Nenhum movimento neste dia.</td></tr>';
                            } else {
                                data.transacoes.forEach(t => {
                                    const corTexto = t.tipo === 'RECEITA' ? 'text-success' : 'text-danger';
                                    const sinal = t.tipo === 'RECEITA' ? '+' : '-';
                                    tbodyTabela.innerHTML += `
                                    <tr>
                                        <td class="py-2">
                                            <div style="width:10px; height:10px; border-radius:50%; background-color:${t.cor}; display:inline-block; margin-right:6px;"></div>
                                            <strong>${t.descricao}</strong><br>
                                            <span class="text-muted" style="font-size:0.75rem;">${t.conta}</span>
                                        </td>
                                        <td class="text-end fw-bold ${corTexto} py-2">
                                            ${sinal} R$ ${t.valor.toFixed(2)}
                                        </td>
                                    </tr>
                                `;
                                });
                            }
                        });
                });
            });

            // ==========================================
            // 4. GR√ÅFICO DE BARRAS (FLUXO DE CAIXA)
            // ==========================================
            const labelsFluxo = JSON.parse('{{ meses_labels|safe }}');
            const dadosReceitas = JSON.parse('{{ receitas_data|safe }}');
            const dadosDespesas = JSON.parse('{{ despesas_data|safe }}');

            const ctxFluxo = document.getElementById('graficoFluxo').getContext('2d');
            const corLinhaGrid = getComputedStyle(document.body).getPropertyValue('--border-color').trim();

            new Chart(ctxFluxo, {
                type: 'bar',
                data: {
                    labels: labelsFluxo,
                    datasets: [
                        {
                            label: 'Receitas',
                            data: dadosReceitas,
                            backgroundColor: 'rgba(46, 204, 113, 0.7)',
                            borderColor: '#2ecc71',
                            borderWidth: 1,
                            borderRadius: 4
                        },
                        {
                            label: 'Despesas',
                            data: dadosDespesas,
                            backgroundColor: 'rgba(231, 76, 60, 0.7)',
                            borderColor: '#e74c3c',
                            borderWidth: 1,
                            borderRadius: 4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: { size: 14 } // Fonte e cor j√° est√£o no defaults
                        },
                        tooltip: {
                            callbacks: {
                                label: function (context) {
                                    return context.dataset.label + ': R$ ' + context.parsed.y.toFixed(2);
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: corLinhaGrid }
                        },
                        x: {
                            ticks: { size: 13 },
                            grid: { display: false }
                        }
                    }
                }
            });

        });
    });
</script>

<!-- Modals transa√ß√£o -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const checkRecorrente = document.getElementById('check_recorrente');
        const divParcelas = document.getElementById('div_parcelas');

        if (checkRecorrente && divParcelas) {
            checkRecorrente.addEventListener('change', function () {
                if (this.checked) {
                    divParcelas.style.display = 'block';
                } else {
                    divParcelas.style.display = 'none';
                }
            });
        }
    });
</script>

<!-- Modais fatura -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // --- L√≥gica para o Modal de Pagamento ---
        const botoesPagar = document.querySelectorAll('.btn-pagar-antecipado');
        const formPagamento = document.getElementById('formPagamentoFatura');
        const inputValor = document.getElementById('valor_pagamento');
        const labelNomeCartao = document.getElementById('modalNomeCartao');

        botoesPagar.forEach(botao => {
            botao.addEventListener('click', function () {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');
                const faturaValor = this.getAttribute('data-fatura-valor');

                labelNomeCartao.textContent = faturaNome;
                inputValor.value = faturaValor.replace(',', '.');
                formPagamento.action = "{% url 'financeiro:pagar_fatura' 0 %}".replace('0', faturaId);
            });
        });

        // --- L√≥gica para o Modal de Nova Compra ---
        const botoesCompra = document.querySelectorAll('.btn-nova-compra');
        const formNovaCompra = document.getElementById('formNovaCompra');
        const labelCompraNomeCartao = document.getElementById('modalCompraNomeCartao');

        // Define a data de hoje como padr√£o no input de data
        const inputDataCompra = document.getElementById('data_compra');
        inputDataCompra.valueAsDate = new Date();

        botoesCompra.forEach(botao => {
            botao.addEventListener('click', function () {
                const faturaId = this.getAttribute('data-fatura-id');
                const faturaNome = this.getAttribute('data-fatura-nome');

                labelCompraNomeCartao.textContent = faturaNome;
                formNovaCompra.action = "{% url 'financeiro:adicionar_compra_cartao' 0 %}".replace('0', faturaId);
            });
        });
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // ... (o seu c√≥digo JavaScript anterior continua aqui) ...

        // L√≥gica para mostrar/esconder o campo de parcelas no Cart√£o
        const checkRecorrenteCartao = document.getElementById('check_recorrente_cartao');
        const divParcelasCartao = document.getElementById('div_parcelas_cartao');

        if (checkRecorrenteCartao && divParcelasCartao) {
            checkRecorrenteCartao.addEventListener('change', function () {
                if (this.checked) {
                    divParcelasCartao.style.display = 'block';
                } else {
                    divParcelasCartao.style.display = 'none';
                }
            });
        }
    });
</script>

{% endblock %}